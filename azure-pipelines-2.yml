trigger: none

pool:
  name: remote pool

variables:
  NODE_VERSION: '16.x'

stages:

# =======================
# 1️⃣ LINTING STAGE
# =======================
- stage: Linting
  displayName: Code Linting
  jobs:
  - job: Lint
    displayName: Run Linters
    steps:

    - task: NodeTool@0
      inputs:
        versionSpec: $(NODE_VERSION)

    - task: PowerShell@2
      displayName: Install Dependencies
      inputs:
        targetType: inline
        script: |
          npm install

    - task: PowerShell@2
      displayName: Biome Lint
      inputs:
        targetType: inline
        script: |
          npm install -g @biomejs/biome
          biome lint .

    - task: PowerShell@2
      displayName: Markdown Lint
      inputs:
        targetType: inline
        script: |
          npm install -g markdownlint-cli
          markdownlint .

    - task: PowerShell@2
      displayName: StyleLint
      inputs:
        targetType: inline
        script: |
          npm install -g stylelint stylelint-config-standard
          stylelint "**/*.css"

# =======================
# 2️⃣ SECURITY (SCA)
# =======================
- stage: Security
  displayName: Software Composition Analysis
  dependsOn: Linting
  jobs:
  - job: SCA
    displayName: RetireJS Scan
    steps:

    - task: NodeTool@0
      inputs:
        versionSpec: $(NODE_VERSION)

    - task: PowerShell@2
      inputs:
        targetType: inline
        script: |
          npm install
          npm install -g retire
          retire --severity high --exitwith 0

# =======================
# 3️⃣ BUILD
# =======================
- stage: Build
  displayName: Build Artifact
  dependsOn: Security
  jobs:
  - job: BuildApp
    steps:

    - task: NodeTool@0
      inputs:
        versionSpec: $(NODE_VERSION)

    - task: PowerShell@2
      inputs:
        targetType: inline
        script: |
          npm install
          npm run build
